<!doctype html>
<html class="h-100" lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <meta name="description" content="AMYboard. The best synth for $29">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
    <meta property="og:title" content="AMYboard. The best synth for $29">
    <meta property="og:image" content="https://amyboard.com/img/amyboard_preview.png">
    <meta property="og:description" content="AMYboard. The best synth for $29">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@shorepinesound">
    <meta name="twitter:creator" content="@shorepinesound">
    <meta name="twitter:title" content="AMYboard. The best synth for $29">
    <meta name="twitter:description" content="AMYboard. The best synth for $29">
    <meta name="twitter:image" content="https://amyboard.com/img/amyboard_preview.png">
    <meta property="og:type" content="product" />
    <meta property="og:url" content="https://amyboard.com/" />
    <meta property="og:site_name" content="AMYboard" />
    <meta property="product:price:amount" content="29.90" />
    <meta property="product:price:currency" content="USD" />
    <meta property="og:availability" content="instock" />
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="96x96" href="img/favicon.png">
    <meta name="author" content="shore pine sound systems">
    <meta name="HandheldFriendly" content="true">
    <title>AMYboard. Now available</title>
    <link rel="stylesheet" href="css/theme.css">
    <link href="css/prism.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/all.css" id="treejs_styles">
    <link rel="stylesheet" href="amyrepl.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/codemirror.min.css" />
    <script src="tree.js"></script>
    <link rel="stylesheet" href="treejs.css" id="treejs_styles">
    <!-- These filenames are replaced by the build system -->
    <script src="AMYBOARDMJS" type="module"></script>
    <script type="text/javascript" id="amy_js_include" src="AMYJS"></script>

    <script src="editor_knobs.js"></script>
    <script src="./mini-coi.js" scope="./"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/webmidi@latest/dist/iife/webmidi.iife.js"></script>
    <script src="vendor/qwerty-hancock.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/python/python.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="examples.js"></script>
    <script type="text/javascript" src="amy_event_layout.generated.js"></script>
    <script type="text/javascript" src="amy_parameters.js"></script>
    <script type="text/javascript" src="spss.js"></script>

    <style>
      /* inter-300 - latin */
      @font-face {
        font-family: 'Inter';
        font-style: normal;
        font-weight: 300;
        font-display: swap;
        src: local(''),
          url('./fonts/inter-v12-latin-300.woff2') format('woff2'), /* Chrome 26+, Opera 23+, Firefox 39+ */
          url('./fonts/inter-v12-latin-300.woff') format('woff'); /* Chrome 6+, Firefox 3.6+, IE 9+, Safari 5.1+ */
      }

      @font-face {
        font-family: 'Inter';
        font-style: normal;
        font-weight: 500;
        font-display: swap;
        src: local(''),
          url('./fonts/inter-v12-latin-500.woff2') format('woff2'), /* Chrome 26+, Opera 23+, Firefox 39+ */
          url('./fonts/inter-v12-latin-500.woff') format('woff'); /* Chrome 6+, Firefox 3.6+, IE 9+, Safari 5.1+ */
      }

      @font-face {
        font-family: 'Inter';
        font-style: normal;
        font-weight: 700;
        font-display: swap;
        src: local(''),
          url('./fonts/inter-v12-latin-700.woff2') format('woff2'), /* Chrome 26+, Opera 23+, Firefox 39+ */
          url('./fonts/inter-v12-latin-700.woff') format('woff'); /* Chrome 6+, Firefox 3.6+, IE 9+, Safari 5.1+ */
      }

      .knob-grid .ui-knob-container {
        width: 68px;
        height: 68px;
        margin: 0 auto;
        overflow: visible;
      }

      .knob-grid {
        --bs-gutter-y: 0.75rem;
      }

      .amy-knob {
        width: 52px;
        height: 52px;
        margin: 0 auto;
        touch-action: none;
        user-select: none;
      }

      .amy-knob:focus-visible .amy-knob-face {
        outline: 2px solid #f2c94c;
        outline-offset: 4px;
      }

      .amy-knob-face {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        position: relative;
        transform: rotate(var(--angle, 135deg));
        background: radial-gradient(circle at 35% 35%, #515151 0%, #2c2c2c 55%, #1a1a1a 100%);
        box-shadow: inset -6px -6px 12px rgba(0, 0, 0, 0.35),
          inset 6px 6px 12px rgba(255, 255, 255, 0.06),
          0 10px 20px rgba(0, 0, 0, 0.25);
      }

      .amy-knob-indicator {
        position: absolute;
        top: 5px;
        left: 50%;
        width: 5px;
        height: 5px;
        background: #f2c94c;
        border-radius: 50%;
        transform: translateX(-50%);
        box-shadow: 0 0 6px rgba(242, 201, 76, 0.7);
      }

      .amy-knob-indicator-log {
        background: #7fd3ff;
        box-shadow: 0 0 6px rgba(127, 211, 255, 0.75);
      }

      .amy-pushbutton {
        width: 52px;
        height: 72px;
        margin: 0 auto;
        border-radius: 10px;
        background: var(--pushbutton-color, #d04437);
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding-top: 6px;
        cursor: pointer;
        user-select: none;
        box-shadow: inset -4px -6px 10px rgba(0, 0, 0, 0.3),
          inset 4px 4px 8px rgba(255, 255, 255, 0.12),
          0 10px 18px rgba(0, 0, 0, 0.28);
      }

      .amy-pushbutton:focus-visible {
        outline: 2px solid #f2c94c;
        outline-offset: 4px;
      }

      .amy-pushbutton-led {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #3a0a0a;
        box-shadow: inset -2px -2px 4px rgba(0, 0, 0, 0.35),
          inset 2px 2px 4px rgba(255, 255, 255, 0.08);
      }

      .amy-pushbutton.is-on .amy-pushbutton-led {
        background: #ff3b2f;
        box-shadow: 0 0 10px rgba(255, 59, 47, 0.9),
          inset 0 0 6px rgba(255, 255, 255, 0.45);
      }

      .amy-select {
        width: 100%;
        display: flex;
        justify-content: center;
      }

      .amy-select-control {
        width: 80px;
        height: 72px;
        display: grid;
        grid-template-rows: 18px 1fr 18px;
        align-items: center;
        justify-items: center;
        background: #1e1e1e;
        color: #f8f8f8;
        border: 1px solid #333;
        border-radius: 10px;
        padding: 4px;
        font-size: 9px;
        box-shadow: inset -4px -4px 8px rgba(0, 0, 0, 0.35),
          inset 4px 4px 8px rgba(255, 255, 255, 0.06);
      }

      .amy-select-control:focus-within {
        outline: 2px solid #f2c94c;
        outline-offset: 2px;
      }

      .amy-select-btn {
        width: 100%;
        height: 18px;
        border: none;
        border-radius: 6px;
        background: #2c2c2c;
        color: #f2c94c;
        font-size: 10px;
        line-height: 1;
        cursor: pointer;
        padding: 0;
        position: relative;
        --arrow-color: #f2c94c;
        --arrow-hole-opacity: 0;
      }

      .amy-select-btn:active {
        background: #3a3a3a;
      }

      .amy-select-btn:disabled {
        cursor: default;
      }

      .amy-select-btn.is-disabled {
        --arrow-color: #666;
        --arrow-hole-opacity: 1;
      }

      .amy-select-btn::before {
        content: "";
        position: absolute;
        left: 50%;
        top: 50%;
        width: 0;
        height: 0;
        border-left: 4px solid transparent;
        border-right: 4px solid transparent;
        transform: translate(-50%, -50%);
      }

      .amy-select-btn::after {
        content: "";
        position: absolute;
        left: 50%;
        top: 50%;
        width: 0;
        height: 0;
        border-left: 3px solid transparent;
        border-right: 3px solid transparent;
        transform: translate(-50%, -50%);
        opacity: var(--arrow-hole-opacity);
      }

      .amy-select-btn-up::before {
        border-bottom: 6px solid var(--arrow-color);
      }

      .amy-select-btn-down::before {
        border-top: 6px solid var(--arrow-color);
      }

      .amy-select-btn-up::after {
        border-bottom: 4px solid #2c2c2c;
      }

      .amy-select-btn-down::after {
        border-top: 4px solid #2c2c2c;
      }

      .amy-select-display {
        width: 100%;
        text-align: center;
        font-size: 9px;
        line-height: 1.1;
        padding: 0 2px;
        color: #f8f8f8;
        user-select: none;
      }

      .knob-spacer {
        width: 68px;
        height: 68px;
        margin: 0 auto;
      }

      .amy-keyboard {
        width: 100%;
        max-width: 900px;
        height: 140px;
        margin: 0 auto;
        position: relative;
        user-select: none;
      }

      #canvas {
        width: 100%;
        max-width: 256px;
        height: auto;
        aspect-ratio: 1 / 1;
        display: block;
      }

      @media (min-width: 800px) {
        .knob-col {
          flex: 0 0 8.333%;
          max-width: 8.333%;
        }
      }

      .knob-section-header {
        text-align: center;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #f2f2f2;
        background: #2b2b2b;
        border-radius: 10px;
        padding: 4px 10px;
        margin: 4px 0 2px;
        font-size: 10px;
        width: 100%;
        box-sizing: border-box;
      }

      .nav-tabs .nav-link {
        font-size: 0.85rem;
        padding: 0.35rem 0.75rem;
      }

      .form-control,
      .form-select,
      .form-check-label {
        font-size: 0.85rem;
      }

      .knob-value {
        font-size: 0.62rem;
        padding: 0.2rem 0.4rem;
      }

      .knob-label {
        font-size: 0.65rem;
        line-height: 1.1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .knob-section {
        flex: 0 0 100%;
        max-width: 100%;
        border-radius: 12px;
        overflow: hidden;
        padding-bottom: 4px;
      }

      @media (min-width: 800px) {
        .knob-section-main {
          flex: 0 0 min(100%, calc(var(--knob-units, var(--knob-count, 14)) * 7.142%));
          max-width: min(100%, calc(var(--knob-units, var(--knob-count, 14)) * 7.142%));
          width: min(100%, calc(var(--knob-units, var(--knob-count, 14)) * 7.142%));
        }
        .knob-section-main .knob-col {
          flex: 0 0 calc(100% * var(--knob-span, 1) / var(--knob-units, var(--knob-count, 14)));
          max-width: calc(100% * var(--knob-span, 1) / var(--knob-units, var(--knob-count, 14)));
        }
      }

      @media (max-width: 799px) {
        .knob-col-spacer {
          display: none;
        }
      }

      #patch-pane {
        background: linear-gradient(135deg, #e6e6e6 0%, #99918b 100%);
        border-radius: 12px;
        padding: 24px;
      }

      .patch-toolbar {
        background:rgba(44, 55, 55, 0.75);
        border-radius: 12px;
        padding: 6px 6px;
        margin-left: -8px;
        margin-right: -8px;
      }

      .patch-select-group .patch-init-btn {
        font-size: 0.75rem;
        padding: 0.25rem 0.6rem;
      }

      .patch-select-group {
        gap: 4px;
      }

      .patch-select-group .form-select {
        font-size: 0.8rem;
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
        max-width: 240px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .patch-save-group {
        gap: 4px;
        align-items: center;
      }

      .patch-save-group .patch-save-btn {
        font-size: 0.75rem;
        padding: 0.25rem 0.6rem;
      }

      .patch-save-group .patch-save-input {
        max-width: 120px;
        height: calc(1.5em + 0.75rem + 2px);
      }

      .patch-save-group .patch-load-btn {
        font-size: 0.75rem;
        padding: 0.25rem 0.6rem;
      }

      .env-file-list {
        background-color: #002b36;
      }

      .env-file-item {
        width: 100%;
        border: 0;
        margin: 0;
        padding: 2px 5px;
        text-align: left;
        background-color: #002b36;
        color: #839496;
        font-size: 12px;
        border-radius: 0;
      }

      .env-file-item:hover {
        background-color: #073642;
        color: #839496;
      }

      .env-file-item.selected,
      .env-file-item.selected:hover {
        background-color: #606060;
        color: #fff;
      }

      .env-file-empty {
        padding: 6px 8px;
        font-size: 12px;
        color: #839496;
        background-color: #002b36;
      }
    </style>
  </head>

  <body>
    <nav id="navScroll" class="navbar navbar-expand-lg navbar-light fixed-top scrolled" tabindex="0">
      <div class="container">


              <a class="navbar-brand pe-4 fs-4" href="editor.html">
                          <img src="img/amyboard.svg" width="32" height="32" alt="AMYboard logo" />

          <span class="ms-1 fw-bolder">AMYboard online</span>
              </a>


        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="https://github.com/shorepine/amy">
                <img src="img/github-mark.svg" width="24" height="24" /> Github
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://discord.com/invite/TzBFkUb8pG">
                <img src="img/discord-mark-black.svg" width="24" height="24" /> Discord
              </a>
            </li>
          </ul>
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
            <li class="nav-item">

                            <a class="nav-link btn btn-warning btn-xl shadow me-3 rounded-0 mt-2" href="/">
                <img src="img/amyboard.svg" width="24" height="24" /> AMYboard
              </a>


            </li>
          </ul>
        </div>
      </div>
    </nav>



    <script type="module">
      mp = await loadMicroPython({
        linebuffer: false,
        pystack: 64 * 1024, 
        heapsize: 8 * 1024 * 1024
      });
      await sleep_ms(50);
      // Tell MP to start serving a REPL
      await mp.replInit();
      await sleep_ms(50);
      // Start up the AMYboard stuff
      await start_amyboard();
      
      // Fill the ree
      await fill_tree();
      await refresh_amyboard_world_files();

      // Create the editor and see if there's a share URL to decompress into it
      var editorElement = document.getElementById('collapseEditor');
      editor = CodeMirror.fromTextArea(document.getElementById(`code`), { 
        mode: { 
          name: "python", 
          version: 3, 
          singleLineStringErrors: false,
          lint: false
        }, 
        lineNumbers: true, 
        indentUnit: 4, 
        matchBrackets: true,
        spellCheck: false,
        autocorrect: false,
        theme: "lucario",
        lint: false,
      }); 
      editor.setSize(null,editor_height);
      if (typeof flush_pending_environment_editor_load === "function") {
        await flush_pending_environment_editor_load();
      }
      if (typeof load_first_environment_file_into_editor === "function") {
        await load_first_environment_file_into_editor();
      }
    </script>

    <main class="container pt-5 mt-5">
      <div class="card border-0 bg-light shadow-sm mb-3">
        <div class="card-body">
          <form name="amyboard_settings">
            <div class="row align-items-center">
              <div class="col-md-auto align-top small d-flex align-items-center" id="audioin_grow">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="amy_audioin" onClick="toggle_audioin();"/>
                  <label class="form-check-label" for="amy_audioin">Allow audio input</label>
                </div>
              </div>
              <div class="col-12 col-md-4 align-self-start small mt-2 mt-md-0" id="midi-input-col">
                <div id="midi-input-panel">
                  <select onchange="setup_midi_devices()" name="midi_input" class="form-select form-select-sm" aria-label=".form-select-sm example">
                    <option selected>[Not available]</option>
                  </select>
                </div>
              </div>
              <div class="col-12 col-md-4 align-self-start small mt-2 mt-md-0" id="midi-output-col">
                <div id="midi-output-panel">
                  <select onchange="setup_midi_devices()" name="midi_output" class="form-select form-select-sm" aria-label=".form-select-sm example">
                    <option selected>[Not available]</option>
                  </select>
                </div>
              </div>
              <div class="col-12 col-md-8 align-self-start small mt-2 mt-md-0 d-none" id="midi-warning-col">
                <div class="alert alert-warning py-2 mb-0">
                  This page can use WebMIDI on <a href="https://caniuse.com/midi" target="_blank">supported browsers</a>. 
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
      <div class="card border-0 bg-light shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <ul class="nav nav-tabs" id="editorTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="patch-tab" data-bs-toggle="tab" data-bs-target="#patch-pane" type="button" role="tab" aria-controls="patch-pane" aria-selected="true">Patch</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="environment-tab" data-bs-toggle="tab" data-bs-target="#environment-pane" type="button" role="tab" aria-controls="environment-pane" aria-selected="false">Environment</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="upgrade-tab" data-bs-toggle="tab" data-bs-target="#upgrade-pane" type="button" role="tab" aria-controls="upgrade-pane" aria-selected="false">Upgrade Firmware</button>
              </li>
            </ul>
            <button type="button" class="btn btn-sm btn-warning ms-2" onclick="open_send_to_amyboard_modal()">Send to my AMYboard</button>
          </div>
          <div class="tab-content pt-4">
            <div class="tab-pane fade show active" id="patch-pane" role="tabpanel" aria-labelledby="patch-tab">
              <div class="row align-items-center mb-4 patch-toolbar gx-1">
                <div class="col-12 col-md-auto">
                  <select class="form-select" id="midi-channel-select" aria-label="MIDI Channel">
                    <option value="1" selected>Ch 1</option>
                    <option value="2">Ch 2</option>
                    <option value="3">Ch 3</option>
                    <option value="4">Ch 4</option>
                    <option value="5">Ch 5</option>
                    <option value="6">Ch 6</option>
                    <option value="7">Ch 7</option>
                    <option value="8">Ch 8</option>
                    <option value="9">Ch 9</option>
                    <option value="10">Ch 10</option>
                    <option value="11">Ch 11</option>
                    <option value="12">Ch 12</option>
                    <option value="13">Ch 13</option>
                    <option value="14">Ch 14</option>
                    <option value="15">Ch 15</option>
                    <option value="16">Ch 16</option>
                  </select>
                </div>
                <div class="col-12 col-md-1 d-none d-md-block"></div>
                <div class="col-12 col-md-auto mt-2 mt-md-0 d-flex align-items-center">
                  <button class="btn btn-light btn-sm rounded-0" type="button" disabled>Preset</button>
                </div>
                <div class="col-12 col-md-auto">
                  <div class="input-group patch-select-group">
                    <select class="form-select" id="patch-select"></select>
                    <button class="btn btn-warning btn-sm rounded-pill patch-init-btn" type="button" id="patch-init-btn">Load into patch</button>
                  </div>
                </div>
                <div class="col-12 col-md-1 d-none d-md-block"></div>
                <div class="col-12 col-md-auto mt-2 mt-md-0 d-flex align-items-center">
                  <button class="btn btn-light btn-sm rounded-0" type="button" disabled>Patch</button>
                </div>
                <div class="col-12 col-md-auto mt-2 mt-md-0">
                  <div class="d-flex patch-save-group">
                    <input
                      class="form-control form-control-sm knob-value text-center patch-save-input"
                      type="number"
                      id="patch-save-input"
                      min="1024"
                      max="1055"
                      step="1"
                      value="1024"
                    />
                    <button class="btn btn-warning btn-sm rounded-pill patch-load-btn" type="button" id="patch-load-btn">Load</button>
                    <button class="btn btn-danger btn-sm rounded-pill patch-save-btn" type="button" id="patch-save-btn">Save</button>
                  </div>
                </div>
              </div>
              <div class="row g-4 knob-grid" id="knob-grid"></div>
            </div>
            <div class="tab-pane fade" id="environment-pane" role="tabpanel" aria-labelledby="environment-tab">
              <div class="alert fixed-top d-none" id="alert_box"></div>
              <div class="row mb-3">
                <div class="col-12">
                  <div class="d-flex align-items-center mb-2">
                    <span class="px-1 small align-middle">Environments (latest)</span>
                    <button
                      type="button"
                      title="Refresh environments"
                      data-toggle="tooltip"
                      data-placement="top"
                      class="btn btn-sm btn-link text-secondary p-0 ms-2"
                      onclick="refresh_amyboard_world_files()"
                    ><i class="fas fa-sync"></i></button>
                  </div>
                  <div id="amyboard_world_file_list" class="small" style="max-height: 240px; overflow-y: auto;"></div>
                </div>
              </div>
              <div class="row g-0 headertext">
                <div class="col-4 col-md-2 headertext">
                  <span class="px-1 small align-middle">Environment Files</span>
                  <div id="treecontainer"></div>
                </div>
                <div class="col-8 col-md-10 headertext">
                  <span class="px-1 small align-middle">Code editor</span>
                  <section class="input">
                    <div><textarea id="code" name="code"></textarea></div> 
                  </section>
                </div>
              </div>
              <div class="row g-0 py-0 my-0 grippierow">
                <p class="text-center grippie" id="editor_grippie">• • •</p>
              </div>
              <div class="row mb-4 mt-1">
                <div class="col-4 col-md-2">
                  <button type="button" title="Upload file into current environment" data-toggle="tooltip" data-placement="top" class="btn btn-sm btn-primary" onclick="upload()"><i class="fas fa-upload"></i></button>
                </div>
                <div class="col-4 col-md-2">
                  <button type="button" title="Save editor contents to file" data-toggle="tooltip" data-placement="top" class="btn btn-sm btn-danger" onclick="save_editor()"><i class="fas fa-floppy-disk"></i></button>
                  <button type="button" title="Run current environment in AMYboard" data-toggle="tooltip" data-placement="top" class="btn btn-sm btn-success" onclick="run_current_environment()"><i class="fas fa-running"></i></button> 
                </div>
                <div class="col-12 col-md-8 mt-2 mt-md-0">
                  <div class="row g-1">
                    <div class="col-12 col-md-4">
                      <input type="text" id="environment_username" class="small form-control" placeholder="Username" />
                    </div>
                    <div class="col-4 col-md-2">
                      <input type='text' title="Environment name for upload" data-toggle="tooltip" data-placement="top" id="editor_filename" class="small form-control" placeholder="Environment Name"/>
                    </div>
                    <div class="col-8 col-md-4">
                      <input type="text" id="environment_description" class="small form-control" placeholder="Description" />
                    </div>
                    <div class="col-4 col-md-2">
                      <button type="button" class="btn btn-sm btn-primary w-100" onclick="upload_current_environment()">Upload</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row mb-4 mt-1 align-items-start">
                <div class="col-6 col-md-4">
                  <canvas id="canvas" width="256" height="256"></canvas>
                </div>
                <div class="col-6 col-md-4">
                  <div id="cv-knob-grid" class="row g-4"></div>
                </div>
              </div>
              <div class="row mb-4 mt-1">
                <P>Try some examples! They'll load and run in the AMYboard window above.</p>
                <div class="card-body" id="tutorials"></div>
              </div>
            </div> <!-- end environment tab -->
            <div class="tab-pane fade" id="upgrade-pane" role="tabpanel" aria-labelledby="upgrade-tab">
              <div class="esptool-frame-wrap">
                <iframe
                  class="esptool-frame"
                  src="esptool/index.html"
                  title="Adafruit WebSerial ESPTool"
                  allow="serial"
                  loading="lazy"
                ></iframe>
              </div>
            </div>
          </div>
        </div>
      </div> <!-- end patch / env card -->

      <div class="card border-0 bg-light shadow-sm mt-3">
        <div class="card-body">
          <div id="amy-keyboard" class="amy-keyboard"></div>
        </div>
      </div>
    </main>

    <div class="modal fade" id="sendToAmyboardModal" tabindex="-1" aria-labelledby="sendToAmyboardModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="sendToAmyboardModalLabel">Send to my AMYboard</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="send-amyboard-unsupported" class="d-none">
              <p class="mb-0">This browser does not support WebMIDI. Use Chrome, Edge, or Opera to send files to AMYboard.</p>
            </div>
            <div id="send-amyboard-supported" class="d-none">
              <label for="send-amyboard-midi-out" class="form-label">MIDI Out</label>
              <select id="send-amyboard-midi-out" class="form-select mb-3"></select>
              <p class="mb-0">Connect your AMYboard to this MIDI port over MIDI or USB, then click Send.</p>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="send-amyboard-send-btn" onclick="send_to_amyboard_now()">Send</button>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <div class="container small border-top">
        <div class="row py-5 d-flex justify-content-between">
          <div class="col-12 col-lg-6 col-xl-3 border-end p-5">
            <img src="img/shorepine.svg" width="24" height="24" />
            <address class="text-secondary mt-3">
              <strong>shore pine sound systems</strong>
            </address>
            <ul class="nav flex-column">
              <li class="nav-item">
                <a class="nav-link link-secondary ps-0" aria-current="page" href="https://github.com/shorepine">Github</a>
              </li>
              <li class="nav-item">
                <a class="nav-link link-secondary ps-0" href="https://discord.com/invite/TzBFkUb8pG">Discord</a>
              </li>
              <li class="nav-item">
                <a class="nav-link link-secondary ps-0" href="https://instagram.com/shorepinesound">Instagram</a>
              </li>
              <li class="nav-item">
                <a class="nav-link link-secondary ps-0" href="mailto:brian@variogram.com">Email</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </footer>

    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/aos.js"></script>
    <script src="js/prism.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="patches.generated.js"></script>
    <script src="editor_knobs.js"></script>

    <script>
      AOS.init({
        duration: 800,
      });
    </script>

    <script>
      // On keypress or click anywhere, start audio worklet
      document.body.addEventListener('click', start_audio, true); 
      document.body.addEventListener('keydown', start_audio, true); 
  
      let scrollpos = window.scrollY;
      const header = document.querySelector(".navbar");
      const header_height = header.offsetHeight;

      const add_class_on_scroll = () => header.classList.add("scrolled", "shadow-sm");
      const remove_class_on_scroll = () => header.classList.remove("scrolled", "shadow-sm");

      window.addEventListener("scroll", function() {
        scrollpos = window.scrollY;

        if (scrollpos >= header_height) {
          add_class_on_scroll();
        } else {
          remove_class_on_scroll();
        }
      });

      // Handle the grippie bars on the page for the editor & Tulip blocks
      var editor_grippie_held = false;
      var editor_grippie_y_start = 0;

      $('body').on('mouseup', function mouseState(e) {
        editor_grippie_held = false;
      });
      $('#editor_grippie').on('mousedown mousemove', function mouseState(e) {
        if (e.type == "mousedown") {
          e.preventDefault();
          editor_grippie_held = true;
          editor_grippie_y_start = e.clientY;
        }
        if(e.type == "mousemove") {
          if(editor_grippie_held) {
            e.preventDefault();
            editor_height = editor_height + (e.clientY - editor_grippie_y_start);
            if(editor_height < 200) editor_height = 200;
            editor.setSize(null, editor_height);
            document.getElementById('treecontainer').setAttribute("style","height:"+editor_height.toString()+"px");
          }
        }
      });

      // Set up the tooltips
      $(function () {
        $('[data-toggle="tooltip"]').tooltip({delay: { "show": 3000, "hide": 500 }, trigger:'hover'})
      }) 
      $('[rel="tooltip"]').on('click', function () {
        $(this).tooltip('hide')
      });

      // Populate the example pills
      fill_examples();

      // Handle the CV knobs
      const cvGrid = document.getElementById("cv-knob-grid");
      if (cvGrid && typeof init_knobs === "function") {
        window.amy_cv_knobs = [
          { section: "CV Input", min_value: -10, max_value: 10, display_name: "CV1", default_value: 0 },
          { section: "CV Input", min_value: -10, max_value: 10, display_name: "CV2", default_value: 0 }
        ];
        init_knobs(window.amy_cv_knobs, "cv-knob-grid", function(index, value) {
          if (typeof window.amy_cv_knob_change === "function") {
            window.amy_cv_knob_change(index, value);
          }
        });
      }

      if(editor) editor.refresh();
      editor_shown = true;
    </script>
    <script>
      window.addEventListener("DOMContentLoaded", function() {
        const midiChannelSelect = document.getElementById("midi-channel-select");
        if (midiChannelSelect) {
          midiChannelSelect.value = String(window.current_synth || 1);
          midiChannelSelect.addEventListener("change", function() {
            const parsed = Number(midiChannelSelect.value);
            if (Number.isInteger(parsed) && parsed >= 1 && parsed <= 16) {
              window.current_synth = parsed;
              if (typeof window.refresh_knobs_for_channel === "function") {
                window.refresh_knobs_for_channel();
              }
              const patchSelect = document.getElementById("patch-select");
              if (patchSelect) {
                patchSelect.selectedIndex = 0;
              }
            }
          });
        }
        const patchInitButton = document.getElementById("patch-init-btn");
        const patchSelect = document.getElementById("patch-select");
        if (patchInitButton && patchSelect) {
          patchInitButton.addEventListener("click", function() {
            const value = Number.parseInt(patchSelect.value, 10);
            if (!Number.isNaN(value) && typeof window.onPatchChange === "function") {
              window.onPatchChange(value);
            }
          });
        }
        const patchSaveButton = document.getElementById("patch-save-btn");
        const patchSaveInput = document.getElementById("patch-save-input");
        if (patchSaveButton && patchSaveInput) {
          function clampPatchSaveValue() {
            const value = Number.parseInt(patchSaveInput.value, 10);
            if (Number.isNaN(value) || value < 1024 || value > 1055) {
              patchSaveInput.value = "1024";
            }
          }
          patchSaveButton.addEventListener("click", function() {
            clampPatchSaveValue();
            const value = Number.parseInt(patchSaveInput.value, 10);
            if (!Number.isNaN(value) && typeof window.save_to_patch === "function") {
              window.save_to_patch(value);
            }
          });
          patchSaveInput.addEventListener("change", clampPatchSaveValue);
          patchSaveInput.addEventListener("blur", clampPatchSaveValue);
        }
        const patchLoadButton = document.getElementById("patch-load-btn");
        if (patchLoadButton && patchSaveInput) {
          patchLoadButton.addEventListener("click", function() {
            clampPatchSaveValue();
            const value = Number.parseInt(patchSaveInput.value, 10);
            if (!Number.isNaN(value) && typeof window.load_from_patch === "function") {
              window.load_from_patch(value);
            }
          });
        }
        const keyboard = document.getElementById("amy-keyboard");
        if (keyboard) {
          const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
          const flatMap = {
            "DB": "C#",
            "EB": "D#",
            "GB": "F#",
            "AB": "G#",
            "BB": "A#"
          };
          const noteToMidi = function(note) {
            if (typeof note !== "string") return null;
            const cleaned = note.trim().toUpperCase();
            const match = cleaned.match(/^([A-G]#?|[A-G]B)(-?\\d+)$/);
            if (!match) return null;
            const normalized = flatMap[match[1]] || match[1];
            const noteIndex = noteNames.indexOf(normalized);
            if (noteIndex < 0) return null;
            const octave = Number(match[2]);
            return (octave + 1) * 12 + noteIndex;
          };
          const freqToMidi = function(freq) {
            if (!Number.isFinite(freq) || freq <= 0) return null;
            return Math.round(69 + 12 * Math.log2(freq / 440));
          };

          const QwertyCtor = (window.QwertyHancock && (window.QwertyHancock.QwertyHancock || window.QwertyHancock.default)) || window.QwertyHancock;
          if (!QwertyCtor) {
            console.error("QwertyHancock constructor not found.");
            return;
          }
          const qwerty = new QwertyCtor({
            id: "amy-keyboard",
            width: Math.min(900, keyboard.clientWidth || 900),
            height: 140,
            octaves: 2,
            startNote: "C3",
            musicalTyping: false,
            whiteKeyColour: "#f8f8f8",
            blackKeyColour: "#111",
            activeColour: "#f2c94c",
            borderColour: "#111"
          });

          qwerty.keyDown = function(note, freq) {
            const midi = noteToMidi(note);
            const midiFromFreq = freqToMidi(freq);
            const finalMidi = Number.isFinite(midi) ? midi : midiFromFreq;
            if (Number.isFinite(finalMidi)) {
              amy_add_log_message("i"+window.current_synth+"l1n" + finalMidi);
            }
            if (typeof window.onKeyboardNote === "function") {
              window.onKeyboardNote(finalMidi, note);
            }
          };

          qwerty.keyUp = function(note, freq) {
            const midi = noteToMidi(note);
            const midiFromFreq = freqToMidi(freq);
            const finalMidi = Number.isFinite(midi) ? midi : midiFromFreq;
            if (Number.isFinite(finalMidi)) {
              amy_add_log_message("i"+window.current_synth+"l0n" + finalMidi);
            }
          };
        }
      });
    </script>
  </body>
</html>
